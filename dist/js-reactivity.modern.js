Object.prototype.compare=function(e,t){if(!e||!t)return!1;if(Object.keys(e).length!=Object.keys(t).length)return!1;for(var o in e){if(e.hasOwnProperty(o)!==t.hasOwnProperty(o))return!1;switch(typeof e[o]){case"object":if(!Object.compare(e[o],t[o]))return!1;break;case"function":if(void 0===t[o]||"compare"!=o&&e[o].toString()!=t[o].toString())return!1;break;default:if(e[o]!=t[o])return!1}}for(var o in t)if(void 0===e[o])return!1;return!0},Array.prototype.inArray=function(e){return-1!==this.indexOf(e)},Array.prototype.pushIfNotExist=function(e){this.inArray(e)||this.push(e)},Array.prototype.getDiff=function(e){var t=[];return this.forEach((o,a)=>{Object.compare(o,e[a])||t.push(a)}),t},Array.prototype.getLast=function(){return this[this.length-1]};class e{static deepCopy(e){return JSON.parse(JSON.stringify(e))}static getNested(e,t=self,o=!1,a="."){return e=o?"_refs."+e:e,(Array.isArray(e)?e:e.split(a)).reduce((e,t)=>e&&e[t],t)}static flatObject(e){return Object.keys(e).reduce((t,o)=>function e(t,o,a,r=""){const n=[r,o].filter(e=>e).join(".");return"object"==typeof a?Object.keys(a).reduce((t,o)=>e(t,o,a[o],n),t):Object.assign(t,{[n]:a})}(t,o,e[o]),{})}static isNumber(e){return/^\d+$/.test(e)}static getNestedFromObj(t){for(var o=null==t?void 0:t.scope,a="",r=null==t?void 0:t.name;!e.getNested(a+r,o,!0);){var n,i=null===(n=o)||void 0===n?void 0:n.appData.loop;if(!i)break;if(o=i.scope)a=`${i.name}.${i.index}.${a}`;else{var s=i.baseElement.appData.loop;o=s.scope,a=`${s.name}.${i.index}.${a}`}}return{controller:o,path:a+r,value:e.getNested(a+r,o,!0)}}}class t{static get elements(){return[].concat(t.variables,t.loops,t.conditions)}}t.controllers=[],t.variables=[],t.loops=[],t.conditions=[],Element.prototype.setAppData=function(t,o=null){this.appData||(this.appData={}),o?this.appData[o]=t:this.appData=e.deepCopy(t)},Element.prototype.appendBefore=function(e){e.parentNode.insertBefore(this,e)},Element.prototype.appendAfter=function(e){e.parentNode.insertBefore(this,e.nextSibling)},Element.prototype.show=function(){this.classList.remove("hidden")},Element.prototype.hide=function(){this.classList.add("hidden")},Element.prototype.getController=function(e){var o=this.closest("[as="+e);return o?t.controllers[o.nodeName]:null},Element.prototype.getLoop=function(e){var o=null;return t.loops.forEach(t=>{var a=t.appData.loop;if(a.alias==e){if(t.contains(this))return void(o=t);a.siblingElements.forEach(e=>{e.contains(this)&&(o=e)})}}),o};const o={async initControllers(){document.querySelectorAll("[as]").forEach(e=>{var o=e.getAttribute("as");e.setAppData({name:o},"controller");var a=e.nodeName;t.controllers[a]||(t.controllers[a]=e)})},async initLoops(){document.querySelectorAll("[loop]").forEach(e=>{var a=e.getAttribute("loop").split(" "),r=a[2].match(/(.*?)\.(.*)/),n={index:0,scope:e.getController(r[1])||e.getLoop(r[1]),name:r[2],alias:a[0],baseElement:e,siblingElements:[],template:e.innerHTML};e.setAppData(n,"loop"),e.removeAttribute("loop"),t.loops.push(e),o.executeLoop(e).then(o.initLoops)})},async executeLoop(t,o=[]){var a=t.appData.loop,r=a.siblingElements,n=e.getNestedFromObj(a).value;if(o.length){var i=o.length-n.length;i>0?function(e){for(var t=0;t<e;t++)r[r.length-1]&&(r[r.length-1].remove(),r.pop());o.length=n.length}(i):i<0&&s(n,n.length+i),o.getDiff(n).forEach(e=>{!function(e){(0==e?t:r[e-1]).innerHTML=a.template}(e)})}else r.length=0,s(n);function s(e,o=1){null==e||e.forEach((e,a)=>{if(a>=o){var n=document.createElement(t.nodeName);n.innerHTML=t.appData.loop.template,n.setAppData({index:a,baseElement:t},"loop"),n.appendAfter(r.getLast()||t),r.push(n)}})}},initVariables(){document.querySelectorAll("[var]").forEach(e=>{var a=e.getAttribute("var"),r=a.match(/(.*?)\.(.*)/),n=r?r[1]:a,i={scope:e.getController(n)||e.getLoop(n),name:r?r[2]:[]};e.setAppData(i,"variable"),e.removeAttribute("var"),t.variables.push(e),o.executeVariable(e)})},executeVariable(t){var o=t.appData.variable,a=o.scope,r=o.name;if(a.appData.loop){var n=a.appData.loop,i=e.getNestedFromObj(n.baseElement.appData.loop).value;(null==i?void 0:i.length)&&(t.innerHTML=e.getNested(r,i[n.index]))}else t.innerHTML=e.getNested(r,a,!0)},initConditions(){document.querySelectorAll("[if]").forEach(e=>{var a=e.getAttribute("if").match(/(.*?)\.(.*)/),r="!"==a[1].charAt(0);a[1]=a[1].replace("!","");var n={negative:r,scope:e.getController(a[1])||e.getLoop(a[1]),name:a[2]};e.setAppData(n,"condition"),e.removeAttribute("if"),t.conditions.push(e),o.executeCondition(e)})},executeCondition(t){var o=t.appData.condition;!!e.getNested(o.name,o.scope,!0)==!o.negative?t.show():t.hide()},initEvents(){document.querySelectorAll("[click]").forEach(t=>{if(!t.appData||!t.appData.event){var o=t.getAttribute("click").match(/(.*?)\.(.*)/),a={name:"click",scope:t.getController(o[1]),method:o[2].match(/(.*)(?=\()/)[1],properties:(r=o[2].match(/(\()(.*)(?=\))/)[2].split(","),r=r.map(o=>{if(o){if(/^'.*'$/.test(o))return o.match(/'(.*)'/)[1].replace("'","");var a=o.match(/(.*?)\.(.*)/),r=t.getController(a[1])||t.getLoop(a[1]);return e.getNested(a[2],r,!0)}return null}))};t.setAppData(a,"event"),t.addEventListener(a.name,()=>a.scope[a.method](...a.properties))}var r})},cleanDom(){["as","loop","var","if"].forEach(e=>{document.querySelectorAll(`[${e}]`).forEach(t=>t.removeAttribute(e))})}};class a extends HTMLElement{constructor(){super(),this._refs=null}observe(a,r=null){var n=this;return new Proxy(a,{get(e,t){const o=e[t];return"object"==typeof o?new Proxy(o,this):o},set(a,i,s){"function"==typeof r&&r(i,s);var p=e.deepCopy(a);a[i]=s;var l=t.controllers[n.nodeName];if(l){var c=[];t.elements.forEach(t=>{for(var o in t.appData){var a;if((null===(a=t.appData[o].scope)||void 0===a?void 0:a.nodeName)==l.nodeName)c.pushIfNotExist(t);else{var r,n=null===(r=t.appData[o].scope)||void 0===r?void 0:r.appData.loop.baseElement.appData.loop,i=e.getNestedFromObj(n).controller;(null==i?void 0:i.nodeName)==l.nodeName&&c.pushIfNotExist(t)}}});var u=[];c.forEach(t=>{for(var o in t.appData){if(u.inArray(t))break;var r=[];e.isNumber(i)?r.push(a):"length"==i?r.push(a,s):r.push(s),(e.isNumber(i)||"length"==i||i==t.appData[o].name)&&r.forEach(a=>{var r,n;r=a,((n=e.getNestedFromObj(t.appData[o])).value===r||"object"==typeof r&&Object.compare(n.value,r))&&u.pushIfNotExist(t)})}}),u.forEach(e=>{e.appData.loop&&o.executeLoop(e,p).then(()=>{o.initVariables(),o.initConditions(),o.initEvents()}),e.appData.variable&&o.executeVariable(e),e.appData.condition&&o.executeCondition(e)})}return!0}})}set refs(e){this._refs=this.observe(e)}get refs(){return this._refs}}class r{static async init(){o.initControllers().then(()=>{o.initLoops().then(()=>{o.initVariables(),o.initConditions(),o.initEvents()})})}}export{a as Component,r as JsReactivity};
