!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).jsReactivity={})}(this,function(e){Object.prototype.compare=function(e,t){if(!e||!t)return!1;if(Object.keys(e).length!=Object.keys(t).length)return!1;for(var n in e){if(e.hasOwnProperty(n)!==t.hasOwnProperty(n))return!1;switch(typeof e[n]){case"object":if(!Object.compare(e[n],t[n]))return!1;break;case"function":if(void 0===t[n]||"compare"!=n&&e[n].toString()!=t[n].toString())return!1;break;default:if(e[n]!=t[n])return!1}}for(var n in t)if(void 0===e[n])return!1;return!0},Array.prototype.inArray=function(e){return-1!==this.indexOf(e)},Array.prototype.pushIfNotExist=function(e){this.inArray(e)||this.push(e)},Array.prototype.getDiff=function(e){var t=[];return this.forEach(function(n,o){Object.compare(n,e[o])||t.push(o)}),t},Array.prototype.getLast=function(){return this[this.length-1]};var t=function(){function e(){}return e.deepCopy=function(e){return JSON.parse(JSON.stringify(e))},e.getNested=function(e,t,n,o){return void 0===t&&(t=self),void 0===n&&(n=!1),void 0===o&&(o="."),e=n?"_refs."+e:e,(Array.isArray(e)?e:e.split(o)).reduce(function(e,t){return e&&e[t]},t)},e.flatObject=function(e){return Object.keys(e).reduce(function(t,n){return function e(t,n,o,r){var i;void 0===r&&(r="");var a=[r,n].filter(function(e){return e}).join(".");return"object"==typeof o?Object.keys(o).reduce(function(t,n){return e(t,n,o[n],a)},t):Object.assign(t,((i={})[a]=o,i))}(t,n,e[n])},{})},e.isNumber=function(e){return/^\d+$/.test(e)},e.getNestedFromObj=function(t){for(var n=null==t?void 0:t.scope,o="",r=null==t?void 0:t.name;!e.getNested(o+r,n,!0);){var i,a=null===(i=n)||void 0===i?void 0:i.appData.loop;if(!a)break;if(n=a.scope)o=a.name+"."+a.index+"."+o;else{var c=a.baseElement.appData.loop;n=c.scope,o=c.name+"."+a.index+"."+o}}return{controller:n,path:o+r,value:e.getNested(o+r,n,!0)}},e}();function n(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function o(e,t,o){return t&&n(e.prototype,t),o&&n(e,o),e}function r(e){return(r=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function i(e,t){return(i=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function a(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function c(e,t,n){return(c=a()?Reflect.construct:function(e,t,n){var o=[null];o.push.apply(o,t);var r=new(Function.bind.apply(e,o));return n&&i(r,n.prototype),r}).apply(null,arguments)}function u(e){var t="function"==typeof Map?new Map:void 0;return(u=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return c(e,arguments,r(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),i(n,e)})(e)}var p=function(){function e(){}return o(e,null,[{key:"elements",get:function(){return[].concat(e.variables,e.loops,e.conditions)}}]),e}();p.controllers=[],p.variables=[],p.loops=[],p.conditions=[],Element.prototype.setAppData=function(e,n){void 0===n&&(n=null),this.appData||(this.appData={}),n?this.appData[n]=e:this.appData=t.deepCopy(e)},Element.prototype.appendBefore=function(e){e.parentNode.insertBefore(this,e)},Element.prototype.appendAfter=function(e){e.parentNode.insertBefore(this,e.nextSibling)},Element.prototype.show=function(){this.classList.remove("hidden")},Element.prototype.hide=function(){this.classList.add("hidden")},Element.prototype.getController=function(e){var t=this.closest("[as="+e);return t?p.controllers[t.nodeName]:null},Element.prototype.getLoop=function(e){var t=this,n=null;return p.loops.forEach(function(o){var r=o.appData.loop;if(r.alias==e){if(o.contains(t))return void(n=o);r.siblingElements.forEach(function(e){e.contains(t)&&(n=e)})}}),n};var l={initControllers:function(){try{return document.querySelectorAll("[as]").forEach(function(e){var t=e.getAttribute("as");e.setAppData({name:t},"controller");var n=e.nodeName;p.controllers[n]||(p.controllers[n]=e)}),Promise.resolve()}catch(e){return Promise.reject(e)}},initLoops:function(){try{return document.querySelectorAll("[loop]").forEach(function(e){var t=e.getAttribute("loop").split(" "),n=t[2].match(/(.*?)\.(.*)/),o={index:0,scope:e.getController(n[1])||e.getLoop(n[1]),name:n[2],alias:t[0],baseElement:e,siblingElements:[],template:e.innerHTML};e.setAppData(o,"loop"),e.removeAttribute("loop"),p.loops.push(e),l.executeLoop(e).then(l.initLoops)}),Promise.resolve()}catch(e){return Promise.reject(e)}},executeLoop:function(e,n){void 0===n&&(n=[]);try{var o=function(t,n){void 0===n&&(n=1),null==t||t.forEach(function(t,o){if(o>=n){var r=document.createElement(e.nodeName);r.innerHTML=e.appData.loop.template,r.setAppData({index:o,baseElement:e},"loop"),r.appendAfter(i.getLast()||e),i.push(r)}})},r=e.appData.loop,i=r.siblingElements,a=t.getNestedFromObj(r).value;if(n.length){var c=n.length-a.length;c>0?function(e){for(var t=0;t<e;t++)i[i.length-1]&&(i[i.length-1].remove(),i.pop());n.length=a.length}(c):c<0&&o(a,a.length+c),n.getDiff(a).forEach(function(t){!function(t){(0==t?e:i[t-1]).innerHTML=r.template}(t)})}else i.length=0,o(a);return Promise.resolve()}catch(e){return Promise.reject(e)}},initVariables:function(){document.querySelectorAll("[var]").forEach(function(e){var t=e.getAttribute("var"),n=t.match(/(.*?)\.(.*)/),o=n?n[1]:t,r={scope:e.getController(o)||e.getLoop(o),name:n?n[2]:[]};e.setAppData(r,"variable"),e.removeAttribute("var"),p.variables.push(e),l.executeVariable(e)})},executeVariable:function(e){var n=e.appData.variable,o=n.scope,r=n.name;if(o.appData.loop){var i=o.appData.loop,a=t.getNestedFromObj(i.baseElement.appData.loop).value;(null==a?void 0:a.length)&&(e.innerHTML=t.getNested(r,a[i.index]))}else e.innerHTML=t.getNested(r,o,!0)},initConditions:function(){document.querySelectorAll("[if]").forEach(function(e){var t=e.getAttribute("if").match(/(.*?)\.(.*)/),n="!"==t[1].charAt(0);t[1]=t[1].replace("!","");var o={negative:n,scope:e.getController(t[1])||e.getLoop(t[1]),name:t[2]};e.setAppData(o,"condition"),e.removeAttribute("if"),p.conditions.push(e),l.executeCondition(e)})},executeCondition:function(e){var n=e.appData.condition;!!t.getNested(n.name,n.scope,!0)==!n.negative?e.show():e.hide()},initEvents:function(){document.querySelectorAll("[click]").forEach(function(e){if(!e.appData||!e.appData.event){var n=e.getAttribute("click").match(/(.*?)\.(.*)/),o={name:"click",scope:e.getController(n[1]),method:n[2].match(/(.*)(?=\()/)[1],properties:(r=n[2].match(/(\()(.*)(?=\))/)[2].split(","),r=r.map(function(n){if(n){if(/^'.*'$/.test(n))return n.match(/'(.*)'/)[1].replace("'","");var o=n.match(/(.*?)\.(.*)/),r=e.getController(o[1])||e.getLoop(o[1]);return t.getNested(o[2],r,!0)}return null}))};e.setAppData(o,"event"),e.addEventListener(o.name,function(){var e;return(e=o.scope)[o.method].apply(e,o.properties)})}var r})},cleanDom:function(){["as","loop","var","if"].forEach(function(e){document.querySelectorAll("["+e+"]").forEach(function(t){return t.removeAttribute(e)})})}},s=function(e){var n,r;function i(){var t;return(t=e.call(this)||this)._refs=null,t}return r=e,(n=i).prototype=Object.create(r.prototype),n.prototype.constructor=n,n.__proto__=r,i.prototype.observe=function(e,n){void 0===n&&(n=null);var o=this;return new Proxy(e,{get:function(e,t){var n=e[t];return"object"==typeof n?new Proxy(n,this):n},set:function(e,r,i){"function"==typeof n&&n(r,i);var a=t.deepCopy(e);e[r]=i;var c=p.controllers[o.nodeName];if(c){var u=[];p.elements.forEach(function(e){for(var n in e.appData){var o;if((null===(o=e.appData[n].scope)||void 0===o?void 0:o.nodeName)==c.nodeName)u.pushIfNotExist(e);else{var r,i=null===(r=e.appData[n].scope)||void 0===r?void 0:r.appData.loop.baseElement.appData.loop,a=t.getNestedFromObj(i).controller;(null==a?void 0:a.nodeName)==c.nodeName&&u.pushIfNotExist(e)}}});var s=[];u.forEach(function(n){for(var o in n.appData){if(s.inArray(n))break;var a=[];t.isNumber(r)?a.push(e):"length"==r?a.push(e,i):a.push(i),(t.isNumber(r)||"length"==r||r==n.appData[o].name)&&a.forEach(function(e){var r,i;r=e,((i=t.getNestedFromObj(n.appData[o])).value===r||"object"==typeof r&&Object.compare(i.value,r))&&s.pushIfNotExist(n)})}}),s.forEach(function(e){e.appData.loop&&l.executeLoop(e,a).then(function(){l.initVariables(),l.initConditions(),l.initEvents()}),e.appData.variable&&l.executeVariable(e),e.appData.condition&&l.executeCondition(e)})}return!0}})},o(i,[{key:"refs",set:function(e){this._refs=this.observe(e)},get:function(){return this._refs}}]),i}(u(HTMLElement)),f=function(){function e(){}return e.init=function(){try{return l.initControllers().then(function(){l.initLoops().then(function(){l.initVariables(),l.initConditions(),l.initEvents()})}),Promise.resolve()}catch(e){return Promise.reject(e)}},e}();e.Component=s,e.JsReactivity=f});
